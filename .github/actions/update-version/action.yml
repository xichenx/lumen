name: 'Update Version in version.properties'
description: 'Update module version in version.properties file and commit back to repository'

inputs:
  module_name:
    description: 'Module name (e.g., core, transform, view, compose, bom)'
    required: true
  version:
    description: 'Version to write'
    required: true
  git_token:
    description: 'GitHub token for committing'
    required: true

runs:
  using: 'composite'
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        token: ${{ inputs.git_token }}
        fetch-depth: 0
        persist-credentials: true

    - name: Update version.properties
      shell: bash
      run: |
        MODULE="${{ inputs.module_name }}"
        VERSION="${{ inputs.version }}"
        PROPERTY_NAME="lumen.${MODULE}.version"
        
        echo "ğŸ“ Updating $PROPERTY_NAME to $VERSION in version.properties"
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "version.properties" ]; then
          echo "âŒ version.properties file not found"
          exit 1
        fi
        
        # æ›´æ–°ç‰ˆæœ¬ï¼ˆå¦‚æœå±æ€§å­˜åœ¨åˆ™æ›´æ–°ï¼Œä¸å­˜åœ¨åˆ™è¿½åŠ ï¼‰
        if grep -q "^${PROPERTY_NAME}=" version.properties; then
          # å±æ€§å­˜åœ¨ï¼Œæ›´æ–°å®ƒ
          if [[ "$OSTYPE" == "darwin"* ]]; then
            # macOS
            sed -i '' "s/^${PROPERTY_NAME}=.*/${PROPERTY_NAME}=${VERSION}/" version.properties
          else
            # Linux
            sed -i "s/^${PROPERTY_NAME}=.*/${PROPERTY_NAME}=${VERSION}/" version.properties
          fi
          echo "âœ… Updated existing property: $PROPERTY_NAME=$VERSION"
        else
          # å±æ€§ä¸å­˜åœ¨ï¼Œè¿½åŠ åˆ°æ–‡ä»¶æœ«å°¾
          echo "${PROPERTY_NAME}=${VERSION}" >> version.properties
          echo "âœ… Added new property: $PROPERTY_NAME=$VERSION"
        fi
        
        # æ˜¾ç¤ºæ›´æ–°åçš„å†…å®¹
        echo "ğŸ“‹ Updated version.properties:"
        grep "^lumen\." version.properties || echo "âš ï¸  No lumen.* properties found"

    - name: Commit and push version update
      shell: bash
      run: |
        MODULE="${{ inputs.module_name }}"
        VERSION="${{ inputs.version }}"
        
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
        if git diff --quiet version.properties; then
          echo "â„¹ï¸  No changes to commit (version already set to $VERSION)"
        else
          git add version.properties
          git commit -m "chore: update ${MODULE} version to ${VERSION} [skip ci]"
          git push
          echo "âœ… Committed and pushed version update: ${MODULE}=${VERSION}"
        fi
