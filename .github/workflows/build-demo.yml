name: Build Demo APK

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      build_type:
        description: 'Build type (debug or release)'
        required: true
        default: 'release'
        type: choice
        options:
          - release
          - debug
      version:
        description: 'App version (e.g., 0.0.1). Leave empty for auto-increment'
        required: false
      auto_increment:
        description: 'Auto increment patch version (e.g., 0.0.1 -> 0.0.2)'
        type: boolean
        default: true

# å¹¶å‘æŽ§åˆ¶ï¼šå…è®¸åŒæ—¶è¿è¡Œå¤šä¸ªæž„å»ºä»»åŠ¡ï¼ˆä¸åŒåˆ†æ”¯/PRï¼‰
concurrency:
  group: build-demo-${{ github.ref }}
  cancel-in-progress: true  # å–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§æž„å»º

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ç”¨äºŽåˆ›å»ºRelease
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-home-cache-includes: |
            caches
            notifications
            jdks
      
      - name: Setup signing key (Release builds only)
        if: github.event.inputs.build_type == 'release'
        run: |
          # ä»ŽGitHub Secretsè¯»å–ç­¾åé…ç½®
          if [ -n "${{ secrets.KEYSTORE_BASE64 }}" ] && [ -n "${{ secrets.KEYSTORE_PASSWORD }}" ]; then
            echo "ðŸ” Setting up signing configuration for release build..."
            
            # åˆ›å»ºkeystoreç›®å½•
            mkdir -p app/keystore
            
            # ä»Žsecretsè¯»å–keystoreæ–‡ä»¶ï¼ˆbase64ç¼–ç ï¼‰
            # å¤„ç† Windows certutil -encode æ·»åŠ çš„å¤´éƒ¨å’Œå°¾éƒ¨æ ‡è®°
            # certutil ä¼šåœ¨ç¼–ç å†…å®¹å‰åŽæ·»åŠ  "-----BEGIN CERTIFICATE-----" å’Œ "-----END CERTIFICATE-----"
            # éœ€è¦å…ˆåŽ»é™¤è¿™äº›æ ‡è®°ï¼Œåªä¿ç•™çº¯ Base64 å†…å®¹
            echo "${{ secrets.KEYSTORE_BASE64 }}" | \
              sed -e '/-----BEGIN CERTIFICATE-----/d' \
                  -e '/-----END CERTIFICATE-----/d' \
                  -e '/^$/d' | \
              base64 -d > app/keystore/lumen-release.jks
            chmod 600 app/keystore/lumen-release.jks
            
            # éªŒè¯keystoreæ–‡ä»¶æ˜¯å¦åˆ›å»ºæˆåŠŸ
            if [ -f app/keystore/lumen-release.jks ]; then
              echo "âœ… Keystore file created successfully"
              ls -lh app/keystore/lumen-release.jks
            else
              echo "âŒ Failed to create keystore file"
              exit 1
            fi
            
            # è®¾ç½®çŽ¯å¢ƒå˜é‡ï¼ˆGradleä¼šè‡ªåŠ¨è¯»å–ï¼‰
            KEY_ALIAS_VALUE="${{ secrets.KEY_ALIAS }}"
            KEY_PASSWORD_VALUE="${{ secrets.KEY_PASSWORD }}"
            
            # å¦‚æžœKEY_ALIASæœªè®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
            if [ -z "$KEY_ALIAS_VALUE" ]; then
              KEY_ALIAS_VALUE="lumen-release"
            fi
            
            # å¦‚æžœKEY_PASSWORDæœªè®¾ç½®ï¼Œä½¿ç”¨KEYSTORE_PASSWORD
            if [ -z "$KEY_PASSWORD_VALUE" ]; then
              KEY_PASSWORD_VALUE="${{ secrets.KEYSTORE_PASSWORD }}"
            fi
            
            echo "KEYSTORE_FILE=app/keystore/lumen-release.jks" >> $GITHUB_ENV
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> $GITHUB_ENV
            echo "KEY_ALIAS=$KEY_ALIAS_VALUE" >> $GITHUB_ENV
            echo "KEY_PASSWORD=$KEY_PASSWORD_VALUE" >> $GITHUB_ENV
            
            # åŒæ—¶å†™å…¥ gradle.properties ä»¥ç¡®ä¿ Gradle èƒ½è¯»å–åˆ°ï¼ˆä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆï¼‰
            # å…ˆåˆ é™¤æ—§çš„ç­¾åé…ç½®ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            sed -i '/^# CI\/CD signing configuration (auto-generated)/,/^KEY_PASSWORD=/d' gradle.properties 2>/dev/null || true
            
            # è¿½åŠ æ–°çš„ç­¾åé…ç½®
            echo "" >> gradle.properties
            echo "# CI/CD signing configuration (auto-generated)" >> gradle.properties
            echo "KEYSTORE_FILE=app/keystore/lumen-release.jks" >> gradle.properties
            echo "KEYSTORE_PASSWORD=${{ secrets.KEYSTORE_PASSWORD }}" >> gradle.properties
            echo "KEY_ALIAS=$KEY_ALIAS_VALUE" >> gradle.properties
            echo "KEY_PASSWORD=$KEY_PASSWORD_VALUE" >> gradle.properties
            
            echo "âœ… Signing configuration ready:"
            echo "   Keystore: app/keystore/lumen-release.jks"
            echo "   Alias: $KEY_ALIAS_VALUE"
            echo "   Configuration written to gradle.properties"
          else
            echo "âš ï¸  Signing credentials not configured in GitHub Secrets"
            echo "   Release build will be unsigned (can be used for testing)"
            echo ""
            echo "ðŸ“‹ To enable signing, configure the following GitHub Secrets:"
            echo "   1. KEYSTORE_BASE64 - Base64 encoded keystore file (required)"
            echo "   2. KEYSTORE_PASSWORD - Keystore password (required)"
            echo "   3. KEY_ALIAS - Key alias (optional, defaults to 'lumen')"
            echo "   4. KEY_PASSWORD - Key password (optional, defaults to KEYSTORE_PASSWORD)"
            echo ""
            echo "ðŸ’¡ See SIGNING_SETUP.md for detailed instructions"
          fi
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Calculate and update version
        id: version
        run: |
          # èŽ·å–åˆ†æ”¯ä¿¡æ¯
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # è¯»å–å½“å‰ç‰ˆæœ¬ï¼ˆåŽ»é™¤ç©ºæ ¼å’Œç©ºå€¼ï¼‰
          CURRENT_APP_VERSION=$(grep "^APP_VERSION_NAME=" gradle.properties | cut -d'=' -f2 | xargs || echo "")
          CURRENT_APP_VERSION_CODE=$(grep "^APP_VERSION_CODE=" gradle.properties | cut -d'=' -f2 | xargs || echo "")
          
          # å¦‚æžœå€¼ä¸ºç©ºå­—ç¬¦ä¸²ï¼Œè§†ä¸ºæœªè®¾ç½®
          if [ -z "$CURRENT_APP_VERSION" ] || [ "$CURRENT_APP_VERSION" == "" ]; then
            CURRENT_APP_VERSION=""
          fi
          if [ -z "$CURRENT_APP_VERSION_CODE" ] || [ "$CURRENT_APP_VERSION_CODE" == "" ]; then
            CURRENT_APP_VERSION_CODE=""
          fi
          
          # æ ¹æ®åˆ†æ”¯è®¾ç½®ç‰ˆæœ¬è§„åˆ™
          if [ "$BRANCH_NAME" == "main" ] || [ "$BRANCH_NAME" == "master" ]; then
            # mainåˆ†æ”¯ï¼šä»Ž0.0.1å¼€å§‹
            if [ -z "$CURRENT_APP_VERSION" ]; then
              BASE_VERSION="0.0.1"
            else
              BASE_VERSION="$CURRENT_APP_VERSION"
            fi
          elif [ "$BRANCH_NAME" == "develop" ]; then
            # developåˆ†æ”¯ï¼šä»Ž1.0.0å¼€å§‹
            if [ -z "$CURRENT_APP_VERSION" ]; then
              BASE_VERSION="1.0.0"
            else
              BASE_VERSION="$CURRENT_APP_VERSION"
            fi
          else
            # å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨å½“å‰ç‰ˆæœ¬æˆ–é»˜è®¤å€¼
            BASE_VERSION=${CURRENT_APP_VERSION:-"0.0.1"}
          fi
          
          # ç¡®å®šæœ€ç»ˆç‰ˆæœ¬
          if [ -n "${{ github.event.inputs.version }}" ]; then
            NEW_APP_VERSION="${{ github.event.inputs.version }}"
            echo "Using manually specified version: $NEW_APP_VERSION"
          elif [ "${{ github.event.inputs.auto_increment }}" == "true" ]; then
            # è‡ªåŠ¨é€’å¢žæœ€åŽä¸€ä½
            NEW_APP_VERSION=$(echo "$BASE_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
            echo "Auto-incremented version: $BASE_VERSION -> $NEW_APP_VERSION"
          else
            NEW_APP_VERSION="$BASE_VERSION"
            echo "Using current version: $NEW_APP_VERSION"
          fi
          
          # éªŒè¯ç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$NEW_APP_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
            echo "âŒ Invalid version format: $NEW_APP_VERSION"
            echo "Expected format: X.Y.Z (e.g., 0.0.1)"
            exit 1
          fi
          
          # è®¡ç®—ç‰ˆæœ¬ä»£ç ï¼ˆåŸºäºŽç‰ˆæœ¬å·ï¼‰
          MAJOR=$(echo "$NEW_APP_VERSION" | cut -d'.' -f1)
          MINOR=$(echo "$NEW_APP_VERSION" | cut -d'.' -f2)
          PATCH=$(echo "$NEW_APP_VERSION" | cut -d'.' -f3)
          # ç‰ˆæœ¬ä»£ç  = ä¸»ç‰ˆæœ¬*10000 + æ¬¡ç‰ˆæœ¬*100 + ä¿®è®¢ç‰ˆæœ¬
          NEW_APP_VERSION_CODE=$((MAJOR * 10000 + MINOR * 100 + PATCH))
          
          # æ›´æ–° gradle.properties
          if grep -q "^APP_VERSION_NAME=" gradle.properties; then
            sed -i "s/^APP_VERSION_NAME=.*/APP_VERSION_NAME=$NEW_APP_VERSION/" gradle.properties
          else
            echo "APP_VERSION_NAME=$NEW_APP_VERSION" >> gradle.properties
          fi
          
          if grep -q "^APP_VERSION_CODE=" gradle.properties; then
            sed -i "s/^APP_VERSION_CODE=.*/APP_VERSION_CODE=$NEW_APP_VERSION_CODE/" gradle.properties
          else
            echo "APP_VERSION_CODE=$NEW_APP_VERSION_CODE" >> gradle.properties
          fi
          
          # ç”Ÿæˆtagåç§°
          TAG_NAME="demo-v${NEW_APP_VERSION}"
          
          # è¾“å‡ºç‰ˆæœ¬ä¿¡æ¯
          echo "app_version=$NEW_APP_VERSION" >> $GITHUB_OUTPUT
          echo "app_version_code=$NEW_APP_VERSION_CODE" >> $GITHUB_OUTPUT
          echo "version_name=$NEW_APP_VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          
          # ç”Ÿæˆæž„å»ºä¿¡æ¯
          BUILD_DATE=$(date +'%Y%m%d-%H%M%S')
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          echo "build_date=$BUILD_DATE" >> $GITHUB_OUTPUT
          echo "commit_sha=$COMMIT_SHA" >> $GITHUB_OUTPUT
          echo "build_type=${{ github.event.inputs.build_type || 'release' }}" >> $GITHUB_OUTPUT
          
          echo "âœ… Version calculated:"
          echo "  Branch: $BRANCH_NAME"
          echo "  Base Version: $BASE_VERSION"
          echo "  Final Version: $NEW_APP_VERSION (Code: $NEW_APP_VERSION_CODE)"
          echo "  Tag: $TAG_NAME"
          echo "  Build Date: $BUILD_DATE"
          echo "  Commit: $COMMIT_SHA"
          
          # æ˜¾ç¤ºæ›´æ–°åŽçš„é…ç½®
          echo ""
          echo "ðŸ“‹ Updated gradle.properties:"
          grep -E "^(APP_VERSION_NAME|APP_VERSION_CODE)=" gradle.properties || true
      
      - name: Verify signing setup before build
        if: github.event.inputs.build_type == 'release'
        run: |
          echo "ðŸ” Verifying signing setup before build..."
          
          # æ£€æŸ¥ keystore æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ -f "app/keystore/lumen-release.jks" ]; then
            echo "âœ… Keystore file exists: app/keystore/lumen-release.jks"
            ls -lh app/keystore/lumen-release.jks
          else
            echo "âŒ Keystore file not found: app/keystore/lumen-release.jks"
            exit 1
          fi
          
          # æ£€æŸ¥çŽ¯å¢ƒå˜é‡
          echo ""
          echo "ðŸ“‹ Environment variables:"
          echo "   KEYSTORE_FILE=${KEYSTORE_FILE:-not set}"
          echo "   KEYSTORE_PASSWORD=${KEYSTORE_PASSWORD:+***hidden***}"
          echo "   KEY_ALIAS=${KEY_ALIAS:-not set}"
          echo "   KEY_PASSWORD=${KEY_PASSWORD:+***hidden***}"
          
          # æ£€æŸ¥ gradle.properties
          echo ""
          echo "ðŸ“‹ gradle.properties signing config:"
          grep -E "^(KEYSTORE_FILE|KEYSTORE_PASSWORD|KEY_ALIAS|KEY_PASSWORD)=" gradle.properties | sed 's/=.*/=***hidden***/' || echo "   No signing config found in gradle.properties"
      
      - name: Build APK
        id: build
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          echo "ðŸ”¨ Building $BUILD_TYPE APK..."
          
          # æ¸…ç†ä¹‹å‰çš„æž„å»ºï¼ˆä½†ä¸æ¸…ç† keystore æ–‡ä»¶ï¼‰
          ./gradlew clean --no-daemon --console=plain || true
          
          # æ ¹æ®æž„å»ºç±»åž‹é€‰æ‹©æž„å»ºä»»åŠ¡
          if [ "$BUILD_TYPE" == "release" ]; then
            ./gradlew :app:assembleRelease \
              --parallel \
              --max-workers=4 \
              --stacktrace \
              --no-daemon \
              --console=plain
          else
            ./gradlew :app:assembleDebug \
              --parallel \
              --max-workers=4 \
              --stacktrace \
              --no-daemon \
              --console=plain
          fi
          
          if [ $? -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build completed successfully"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build failed"
            exit 1
          fi
      
      - name: Find APK
        id: find_apk
        run: |
          BUILD_TYPE="${{ github.event.inputs.build_type || 'release' }}"
          
          if [ "$BUILD_TYPE" == "release" ]; then
            # æŸ¥æ‰¾release APKï¼ˆæ”¯æŒ AGP 8.0+ æ–°è·¯å¾„å’Œä¼ ç»Ÿè·¯å¾„ï¼‰
            # ä¼˜å…ˆæŸ¥æ‰¾é‡å‘½ååŽçš„ Lumen.apk
            APK_PATH=$(find app/release app/build/outputs/apk/release -name "Lumen.apk" 2>/dev/null | head -1)
            # å¦‚æžœæ²¡æ‰¾åˆ°ï¼ŒæŸ¥æ‰¾ä»»ä½• APK æ–‡ä»¶
            if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
              APK_PATH=$(find app/release app/build/outputs/apk/release -name "*.apk" 2>/dev/null | head -1)
            fi
            SEARCH_DIRS="app/release or app/build/outputs/apk/release"
          else
            # æŸ¥æ‰¾debug APKï¼ˆæ”¯æŒ AGP 8.0+ æ–°è·¯å¾„å’Œä¼ ç»Ÿè·¯å¾„ï¼‰
            # ä¼˜å…ˆæŸ¥æ‰¾é‡å‘½ååŽçš„ Lumen-debug.apk
            APK_PATH=$(find app/debug app/build/outputs/apk/debug -name "Lumen-debug.apk" 2>/dev/null | head -1)
            # å¦‚æžœæ²¡æ‰¾åˆ°ï¼ŒæŸ¥æ‰¾ä»»ä½• APK æ–‡ä»¶
            if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
              APK_PATH=$(find app/debug app/build/outputs/apk/debug -name "*.apk" 2>/dev/null | head -1)
            fi
            SEARCH_DIRS="app/debug or app/build/outputs/apk/debug"
          fi
          
          if [ -z "$APK_PATH" ] || [ ! -f "$APK_PATH" ]; then
            echo "âŒ APK not found!"
            echo "Searched in: $SEARCH_DIRS"
            echo "Checking app/release:"
            ls -la app/release 2>/dev/null || echo "  Directory does not exist"
            echo "Checking app/build/outputs/apk/release:"
            ls -la app/build/outputs/apk/release 2>/dev/null || echo "  Directory does not exist"
            exit 1
          fi
          
          APK_NAME=$(basename "$APK_PATH")
          APK_SIZE=$(du -h "$APK_PATH" | cut -f1)
          
          echo "apk_path=$APK_PATH" >> $GITHUB_OUTPUT
          echo "apk_name=$APK_NAME" >> $GITHUB_OUTPUT
          echo "apk_size=$APK_SIZE" >> $GITHUB_OUTPUT
          
          echo "âœ… Found APK: $APK_NAME ($APK_SIZE)"
          echo "   Location: $APK_PATH"
          ls -lh "$APK_PATH"
      
      - name: Get APK info
        id: apk_info
        run: |
          APK_PATH="${{ steps.find_apk.outputs.apk_path }}"
          
          # ä½¿ç”¨ aapt èŽ·å– APK ä¿¡æ¯ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if command -v aapt &> /dev/null; then
            PACKAGE_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*name='\([^']*\)'.*/\1/")
            VERSION_NAME=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*versionName='\([^']*\)'.*/\1/")
            VERSION_CODE=$(aapt dump badging "$APK_PATH" | grep "package:" | sed "s/.*versionCode='\([^']*\)'.*/\1/")
            
            echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
            echo "apk_version_name=$VERSION_NAME" >> $GITHUB_OUTPUT
            echo "apk_version_code=$VERSION_CODE" >> $GITHUB_OUTPUT
          else
            echo "âš ï¸  aapt not available, skipping APK info extraction"
          fi
      
      - name: Commit version and create tag
        if: |
          steps.build.outputs.build_success == 'true' &&
          github.event.inputs.build_type == 'release'
        run: |
          NEW_VERSION="${{ steps.version.outputs.app_version }}"
          TAG_NAME="${{ steps.version.outputs.tag_name }}"
          BRANCH_NAME="${{ steps.version.outputs.branch_name }}"
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ç‰ˆæœ¬å˜æ›´
          if ! git diff --quiet gradle.properties; then
            echo "ðŸ“ Committing version update to $BRANCH_NAME branch"
            git add gradle.properties
            git commit -m "chore: bump demo version to $NEW_VERSION [skip ci]"
            
            # æŽ¨é€åˆ°å½“å‰åˆ†æ”¯
            git push origin HEAD:$BRANCH_NAME || {
              echo "âš ï¸  Failed to push version update, but build will continue"
            }
          else
            echo "â„¹ï¸  No version change detected, skipping commit"
          fi
          
          # åˆ›å»ºå¹¶æŽ¨é€tagï¼ˆä»…releaseåŒ…åˆ›å»ºtagï¼‰
          if ! git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "ðŸ·ï¸  Creating tag: $TAG_NAME"
            git tag -a "$TAG_NAME" -m "Demo APK v$NEW_VERSION"
            git push origin "$TAG_NAME" || {
              echo "âš ï¸  Failed to push tag, but build will continue"
            }
          else
            echo "â„¹ï¸  Tag $TAG_NAME already exists, skipping tag creation"
          fi
      
      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: demo-apk-${{ steps.version.outputs.app_version }}-${{ steps.version.outputs.build_date }}
          path: ${{ steps.find_apk.outputs.apk_path }}
          retention-days: 30
          compression-level: 6
      
      - name: Create GitHub Release
        if: |
          steps.build.outputs.build_success == 'true' &&
          github.event.inputs.build_type == 'release'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag_name }}
          name: Demo APK ${{ steps.version.outputs.app_version }}
          body: |
            ## ðŸ“± Demo APK Release
            
            ### ðŸ“¦ Build Information
            
            - **App Version**: `${{ steps.version.outputs.app_version }}` (Code: `${{ steps.version.outputs.app_version_code }}`)
            - **Build Type**: `${{ github.event.inputs.build_type || 'release' }}`
            - **Build Date**: `${{ steps.version.outputs.build_date }}`
            - **Commit**: `${{ steps.version.outputs.commit_sha }}`
            - **Branch**: `${{ steps.version.outputs.branch_name }}`
            - **APK Size**: `${{ steps.find_apk.outputs.apk_size }}`
            - **Tag**: `${{ steps.version.outputs.tag_name }}`
            
            ### ðŸ“¥ Installation
            
            1. Download the APK file below
            2. Enable "Install from unknown sources" on your Android device
            3. Install the APK and enjoy testing the demo!
            
            ### âš ï¸ Note
            
            This is a demo APK for testing purposes. For production use, please use the library from Maven Central.
            
            ### ðŸ”— Links
            
            - [Maven Central](https://repo1.maven.org/maven2/io/github/xichenx/)
            - [Documentation](../../README.md)
          files: ${{ steps.find_apk.outputs.apk_path }}
          draft: false
          prerelease: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ“Š Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build Status | ${{ steps.build.outputs.build_success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Type | \`${{ github.event.inputs.build_type || 'release' }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Library Version | \`${{ steps.version.outputs.version_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| App Version | \`${{ steps.version.outputs.app_version }}\` (\`${{ steps.version.outputs.app_version_code }}\`) |" >> $GITHUB_STEP_SUMMARY
          echo "| APK Name | \`${{ steps.find_apk.outputs.apk_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| APK Size | \`${{ steps.find_apk.outputs.apk_size }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build Date | \`${{ steps.version.outputs.build_date }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Commit | \`${{ steps.version.outputs.commit_sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Branch | \`${{ steps.version.outputs.branch_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build.outputs.build_success }}" == "true" ]; then
            echo "### âœ… Build completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¥ **Download the APK from the Artifacts section above**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### ðŸ“± Installation Instructions" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "1. Download the APK from the Artifacts section" >> $GITHUB_STEP_SUMMARY
            echo "2. Enable \"Install from unknown sources\" on your Android device" >> $GITHUB_STEP_SUMMARY
            echo "3. Transfer the APK to your device and install it" >> $GITHUB_STEP_SUMMARY
            echo "4. Open the app and test the demo features" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please check the build logs above for error details." >> $GITHUB_STEP_SUMMARY
          fi

