name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    # å¹¶å‘æŽ§åˆ¶ï¼šä¸ºæ¯ä¸ª Java ç‰ˆæœ¬åˆ›å»ºç‹¬ç«‹çš„åˆ†ç»„
    concurrency:
      group: ci-${{ github.ref }}-${{ github.workflow }}-java${{ matrix.java-version }}
      cancel-in-progress: true
    
    strategy:
      matrix:
        java-version: [17, 21]
        include:
          - java-version: 17
            java-name: "Java 17"
            java-group: "java17"
          - java-version: 21
            java-name: "Java 21"
            java-group: "java21"
      fail-fast: false  # ä¸€ä¸ªç‰ˆæœ¬å¤±è´¥ä¸å½±å“å…¶ä»–ç‰ˆæœ¬
    
    name: Build and Test (${{ matrix.java-name }})
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up JDK ${{ matrix.java-name }}
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: ${{ matrix.java-version }}
          cache: 'gradle'
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-home-cache-includes: |
            caches
            notifications
            jdks
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Validate Gradle configuration
        run: |
          echo "Validating Gradle configuration..."
          ./gradlew tasks --all --console=plain | head -20
          echo "âœ… Gradle configuration is valid"
      
      - name: Build and test
        id: build_test
        run: |
          echo "ðŸ”¨ Building and testing all modules with ${{ matrix.java-name }}..."
          ./gradlew clean build test \
            --parallel \
            --max-workers=4 \
            --stacktrace \
            --no-daemon \
            --console=plain
          
          if [ $? -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build and test completed successfully"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build or test failed"
            exit 1
          fi
      
      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.java-group }}
          path: |
            **/build/test-results/**/*.xml
          retention-days: 7
          compression-level: 6
      
      - name: Upload build artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs-${{ matrix.java-group }}
          path: |
            **/build/**/*.log
          retention-days: 3
          compression-level: 6
      
      - name: Build summary
        if: always()
        run: |
          echo "## ðŸ“Š CI Summary (${{ matrix.java-name }})" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Build & Test | ${{ steps.build_test.outputs.build_success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.build_test.outputs.build_success }}" == "true" ]; then
            echo "### âœ… All checks passed!" >> $GITHUB_STEP_SUMMARY
          else
            echo "### âŒ Build or test failed" >> $GITHUB_STEP_SUMMARY
            echo "Check the logs above for details." >> $GITHUB_STEP_SUMMARY
          fi

