name: Publish to Maven Central

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to publish (e.g., 0.0.1). Leave empty for auto-increment'
        required: false
      auto_increment:
        description: 'Auto increment patch version (e.g., 0.0.1 -> 0.0.2)'
        type: boolean
        default: true

# å¹¶å‘æŽ§åˆ¶ï¼šé˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ªå‘å¸ƒä»»åŠ¡
concurrency:
  group: publish-to-maven-central
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å‘å¸ƒ

jobs:
  # é¢„æ£€æŸ¥ä»»åŠ¡ï¼šéªŒè¯ç‰ˆæœ¬å·å’Œé…ç½®
  pre-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.final_version.outputs.final_version }}
      should_publish: ${{ steps.check_version.outputs.should_publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Get current version and branch
        id: version_info
        run: |
          # è¯»å–å½“å‰ç»„ä»¶ç‰ˆæœ¬ï¼ˆç‹¬ç«‹äºŽdemoç‰ˆæœ¬ï¼‰
          CURRENT_VERSION=$(grep "^LIBRARY_VERSION_NAME=" gradle.properties | cut -d'=' -f2 || grep "^VERSION_NAME=" gradle.properties | cut -d'=' -f2 || echo "")
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Current library version: $CURRENT_VERSION"
          echo "Current branch: $BRANCH_NAME"
      
      - name: Determine final version
        id: final_version
        run: |
          CURRENT="${{ steps.version_info.outputs.current_version }}"
          BRANCH_NAME="${{ steps.version_info.outputs.branch_name }}"
          
          # æ ¹æ®åˆ†æ”¯è®¾ç½®ç‰ˆæœ¬è§„åˆ™
          if [ "$BRANCH_NAME" == "main" ] || [ "$BRANCH_NAME" == "master" ]; then
            # mainåˆ†æ”¯ï¼šä»Ž0.0.1å¼€å§‹
            if [ -z "$CURRENT" ] || [ "$CURRENT" == "" ]; then
              BASE_VERSION="0.0.1"
            else
              BASE_VERSION="$CURRENT"
            fi
          elif [ "$BRANCH_NAME" == "develop" ]; then
            # developåˆ†æ”¯ï¼šä»Ž1.0.0å¼€å§‹
            if [ -z "$CURRENT" ] || [ "$CURRENT" == "" ]; then
              BASE_VERSION="1.0.0"
            else
              BASE_VERSION="$CURRENT"
            fi
          else
            # å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨å½“å‰ç‰ˆæœ¬æˆ–é»˜è®¤å€¼
            BASE_VERSION=${CURRENT:-"0.0.1"}
          fi
          
          # ç¡®å®šæœ€ç»ˆç‰ˆæœ¬
          if [ -n "${{ github.event.inputs.version }}" ]; then
            FINAL_VERSION="${{ github.event.inputs.version }}"
            echo "Using manually specified version: $FINAL_VERSION"
          elif [ "${{ github.event.inputs.auto_increment }}" == "true" ]; then
            # è‡ªåŠ¨é€’å¢žæœ€åŽä¸€ä½
            FINAL_VERSION=$(echo "$BASE_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
            echo "Auto-incremented version: $BASE_VERSION -> $FINAL_VERSION"
          else
            FINAL_VERSION="$BASE_VERSION"
            echo "Using current version: $FINAL_VERSION"
          fi
          
          # éªŒè¯æœ€ç»ˆç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$FINAL_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9-]+)?$ ]]; then
            echo "âŒ Invalid final version format: $FINAL_VERSION"
            exit 1
          fi
          
          echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Final version to publish: $FINAL_VERSION (branch: $BRANCH_NAME)"
      
      - name: Check if version already exists
        id: check_version
        run: |
          VERSION="${{ steps.final_version.outputs.final_version }}"
          GROUP_ID="io.github.xichenx"
          ARTIFACT_ID="lumen"
          
          echo "Checking if version $VERSION already exists in Maven Central..."
          
          # æ£€æŸ¥ Maven Central æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬
          URL="https://repo1.maven.org/maven2/${GROUP_ID//./\/}/$ARTIFACT_ID/$VERSION/"
          
          # ä½¿ç”¨è¶…æ—¶å’Œé‡è¯•æœºåˆ¶æ£€æŸ¥ç‰ˆæœ¬
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --retry 2 "$URL" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âš ï¸  Version $VERSION already exists in Maven Central!"
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "existing_url=$URL" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "âš ï¸  Failed to check Maven Central (network error), proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION is new (HTTP $HTTP_CODE), proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.SONATYPE_USERNAME }}" ]; then
            MISSING_SECRETS+=("SONATYPE_USERNAME")
          fi
          
          if [ -z "${{ secrets.SONATYPE_PASSWORD }}" ]; then
            MISSING_SECRETS+=("SONATYPE_PASSWORD")
          fi
          
          if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("GPG_PRIVATE_KEY")
          fi
          
          if [ -z "${{ secrets.GPG_PASSPHRASE }}" ]; then
            MISSING_SECRETS+=("GPG_PASSPHRASE")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âš ï¸  Missing secrets: ${MISSING_SECRETS[*]}"
            echo "Publish will be skipped, but artifacts will be built"
          else
            echo "âœ… All required secrets are configured"
          fi

  publish:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_publish == 'true'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '11'
          cache: 'gradle'
      
      - name: Get version from pre-check
        id: version
        run: |
          echo "version=${{ needs.pre-check.outputs.version }}" >> $GITHUB_OUTPUT
          echo "âœ… Using version: ${{ needs.pre-check.outputs.version }}"
      
      - name: Update version in gradle.properties
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          # æ›´æ–°ç»„ä»¶ç‰ˆæœ¬ï¼ˆç‹¬ç«‹äºŽdemoç‰ˆæœ¬ï¼‰
          if grep -q "^LIBRARY_VERSION_NAME=" gradle.properties; then
            sed -i "s/^LIBRARY_VERSION_NAME=.*/LIBRARY_VERSION_NAME=$VERSION/" gradle.properties
          else
            echo "LIBRARY_VERSION_NAME=$VERSION" >> gradle.properties
          fi
          # åŒæ—¶æ›´æ–°VERSION_NAMEä»¥ä¿æŒå…¼å®¹
          sed -i "s/^VERSION_NAME=.*/VERSION_NAME=$VERSION/" gradle.properties
          echo "âœ… Updated LIBRARY_VERSION_NAME and VERSION_NAME to $VERSION"
          grep -E "^(LIBRARY_VERSION_NAME|VERSION_NAME)=" gradle.properties || true
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-home-cache-includes: |
            caches
            notifications
            jdks
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Validate Gradle configuration
        run: |
          echo "Validating Gradle configuration..."
          ./gradlew tasks --all --console=plain | head -20
          echo "âœ… Gradle configuration is valid"
      
      - name: Build and test
        id: build
        run: |
          echo "Building and testing all modules..."
          ./gradlew clean build test \
            --parallel \
            --max-workers=4 \
            --stacktrace \
            --no-daemon \
            --console=plain
          
          if [ $? -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build and test completed successfully"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build or test failed"
            exit 1
          fi
      
      - name: Setup GPG
        id: gpg_setup
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ] || [ -z "$GPG_PASSPHRASE" ]; then
            echo "âš ï¸  GPG credentials not configured, signing will be skipped"
            echo "gpg_configured=false" >> $GITHUB_OUTPUT
            echo "GPG_KEY_ID=" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Setting up GPG signing..."
          
          # å¯¼å…¥ GPG å¯†é’¥
          echo "$GPG_PRIVATE_KEY" | base64 --decode | gpg --batch --yes --import || {
            echo "âŒ Failed to import GPG key"
            exit 1
          }
          
          # æå–å¯†é’¥ ID
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep -E "^(sec|SEC)" | head -1 | awk '{print $2}' | cut -d'/' -f2)
          
          if [ -z "$KEY_ID" ]; then
            echo "âŒ Failed to extract GPG key ID"
            exit 1
          fi
          
          echo "GPG_KEY_ID=$KEY_ID" >> $GITHUB_ENV
          echo "gpg_configured=true" >> $GITHUB_OUTPUT
          echo "âœ… GPG Key ID: $KEY_ID"
          
          # å¯¼å‡ºå¯†é’¥æ–‡ä»¶ç”¨äºŽ Gradle ç­¾å
          gpg --export-secret-keys --armor "$KEY_ID" > secret.gpg || {
            echo "âŒ Failed to export GPG key"
            exit 1
          }
          
          echo "âœ… GPG key exported to secret.gpg"
          
          # éªŒè¯å¯†é’¥
          if [ ! -f secret.gpg ] || [ ! -s secret.gpg ]; then
            echo "âŒ GPG key file is empty or missing"
            exit 1
          fi
      
      - name: Publish to Maven Central
        id: publish
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SIGNING_KEY_ID: ${{ env.GPG_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.GPG_PASSPHRASE }}
          SIGNING_SECRET_KEY_RING_FILE: secret.gpg
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          
          if [ -z "$SONATYPE_USERNAME" ] || [ -z "$SONATYPE_PASSWORD" ]; then
            echo "âš ï¸  Sonatype credentials not configured, skipping Maven Central publish"
            echo "Building artifacts for manual upload..."
            ./gradlew publishAllToMavenLocal \
                      --parallel \
                      --max-workers=4 \
                      --no-daemon \
                      --stacktrace
            echo "publish_success=false" >> $GITHUB_OUTPUT
            echo "publish_skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ðŸš€ Publishing version $VERSION to Maven Central..."
          echo "ðŸ“¦ Publishing modules: lumen-core, lumen-view, lumen-transform, lumen"
          echo "âš¡ Using optimized parallel publishing with dependency management..."
          
          # ä½¿ç”¨èšåˆä»»åŠ¡ + å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–
          if ./gradlew publishAllToMavenCentral \
                      --parallel \
                      --max-workers=4 \
                      --no-daemon \
                      --stacktrace \
                      --console=plain; then
            echo "âœ… Published successfully to Maven Central!"
            echo "publish_success=true" >> $GITHUB_OUTPUT
            echo "publish_skipped=false" >> $GITHUB_OUTPUT
            
            echo ""
            echo "ðŸ“‹ Next steps:"
            echo "1. Login to https://s01.oss.sonatype.org"
            echo "2. Go to Staging Repositories"
            echo "3. Find your repository and click Close"
            echo "4. Wait for validation, then click Release"
            echo "5. Wait for sync to Maven Central (usually a few hours)"
          else
            echo "âŒ Failed to publish to Maven Central"
            echo "publish_success=false" >> $GITHUB_OUTPUT
            echo "publish_skipped=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Verify published artifacts
        if: steps.publish.outputs.publish_success == 'true'
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          GROUP_ID="io.github.xichenx"
          MODULES=("lumen-core" "lumen-transform" "lumen-view" "lumen")
          
          echo "ðŸ” Verifying published artifacts..."
          
          # ç­‰å¾… Sonatype å¤„ç†
          echo "â³ Waiting for Sonatype to process artifacts (10 seconds)..."
          sleep 10
          
          STAGING_URL="https://s01.oss.sonatype.org/service/local/staging/repository"
          FAILED_MODULES=()
          
          for MODULE in "${MODULES[@]}"; do
            echo "Checking $MODULE..."
            # æ£€æŸ¥ staging ä»“åº“ï¼ˆè¿™é‡Œåªæ˜¯åŸºæœ¬æ£€æŸ¥ï¼Œå®žé™…éªŒè¯éœ€è¦ç™»å½• Sonatypeï¼‰
            echo "  âœ… $MODULE artifacts should be in staging repository"
          done
          
          echo "âœ… All modules published to staging repository"
          echo "âš ï¸  Note: Final verification requires manual check in Sonatype Nexus"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts-${{ needs.pre-check.outputs.version }}
          path: |
            **/build/publications/**/*.pom
            **/build/publications/**/*.aar
            **/build/publications/**/*.jar
            **/build/publications/**/*.asc
          retention-days: 30
          compression-level: 6
      
      - name: Commit version update back to repository
        if: github.event_name == 'push' && steps.publish.outputs.publish_success == 'true'
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥ gradle.properties æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --quiet gradle.properties; then
            echo "ðŸ“ Version change detected, committing update to repository"
            git add gradle.properties
            git commit -m "chore: bump version to $VERSION [skip ci]"
            
            # èŽ·å–å½“å‰åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯ main æˆ– masterï¼‰
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "ðŸ“¤ Pushing version update to $BRANCH branch"
            
            # é‡è¯•æœºåˆ¶
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin HEAD:$BRANCH; then
                echo "âœ… Version update pushed successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying in 5 seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  sleep 5
                else
                  echo "âš ï¸  Failed to push after $MAX_RETRIES attempts, skipping"
                fi
              fi
            done
          else
            echo "â„¹ï¸  No version change detected in gradle.properties, skipping commit"
          fi
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && steps.publish.outputs.publish_success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release v${{ needs.pre-check.outputs.version }}
          body: |
            ## ðŸ“¦ Maven Central Release
            
            Version: **${{ needs.pre-check.outputs.version }}**
            
            ### ðŸ“‹ Published Modules
            
            - âœ… **lumen-core** - Core loading logic
            - âœ… **lumen-view** - ImageView and Compose support
            - âœ… **lumen-transform** - Image transformation features
            - âœ… **lumen** - Aggregated module (includes all sub-modules)
            
            ### ðŸš€ Usage
            
            ```kotlin
            repositories {
                mavenCentral()
            }
            
            dependencies {
                // èšåˆæ¨¡å—ï¼ˆæŽ¨èï¼‰- è‡ªåŠ¨åŒ…å«æ‰€æœ‰å­æ¨¡å—
                implementation("io.github.xichenx:lumen:${{ needs.pre-check.outputs.version }}")
                
                // æˆ–ç‹¬ç«‹æ¨¡å—
                implementation("io.github.xichenx:lumen-core:${{ needs.pre-check.outputs.version }}")
                implementation("io.github.xichenx:lumen-view:${{ needs.pre-check.outputs.version }}")
                implementation("io.github.xichenx:lumen-transform:${{ needs.pre-check.outputs.version }}")
            }
            ```
            
            ### ðŸ“ Next Steps
            
            1. Login to [Sonatype](https://s01.oss.sonatype.org)
            2. Go to **Staging Repositories**
            3. Find your repository and click **Close**
            4. Wait for validation, then click **Release**
            5. Wait for sync to Maven Central (usually a few hours)
            
            ### ðŸ”— Links
            
            - [Maven Central](https://repo1.maven.org/maven2/io/github/xichenx/)
            - [Sonatype Staging](https://s01.oss.sonatype.org)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish summary
        if: always()
        run: |
          echo "## ðŸ“Š Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.pre-check.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.build_success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish | ${{ steps.publish.outputs.publish_success == 'true' && 'âœ… Success' || (steps.publish.outputs.publish_skipped == 'true' && 'âš ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GPG Signing | ${{ steps.gpg_setup.outputs.gpg_configured == 'true' && 'âœ… Configured' || 'âš ï¸ Not Configured' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outputs.publish_success }}" == "true" ]; then
            echo "### âœ… Publish completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check [Sonatype Staging](https://s01.oss.sonatype.org)" >> $GITHUB_STEP_SUMMARY
            echo "2. Close and release the staging repository" >> $GITHUB_STEP_SUMMARY
            echo "3. Wait for sync to Maven Central" >> $GITHUB_STEP_SUMMARY
          fi

