name: Publish to Maven Central

on:
  workflow_dispatch:  # ä»…æ”¯æŒæ‰‹åŠ¨è§¦å‘
    inputs:
      version:
        description: 'Version to publish (e.g., 0.0.1). Leave empty for auto-increment'
        required: false
      auto_increment:
        description: 'Auto increment patch version (e.g., 0.0.1 -> 0.0.2)'
        type: boolean
        default: true

# å¹¶å‘æ§åˆ¶ï¼šé˜²æ­¢åŒæ—¶è¿è¡Œå¤šä¸ªå‘å¸ƒä»»åŠ¡
concurrency:
  group: publish-to-maven-central
  cancel-in-progress: false  # ä¸å–æ¶ˆæ­£åœ¨è¿›è¡Œçš„å‘å¸ƒ

jobs:
  # é¢„æ£€æŸ¥ä»»åŠ¡ï¼šéªŒè¯ç‰ˆæœ¬å·å’Œé…ç½®
  pre-check:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    outputs:
      version: ${{ steps.final_version.outputs.final_version }}
      should_publish: ${{ steps.check_version.outputs.should_publish }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Get current version and branch
        id: version_info
        run: |
          # è¯»å–å½“å‰ç»„ä»¶ç‰ˆæœ¬ï¼ˆç‹¬ç«‹äºdemoç‰ˆæœ¬ï¼‰
          CURRENT_VERSION=$(grep "^LIBRARY_VERSION_NAME=" gradle.properties | cut -d'=' -f2 || grep "^VERSION_NAME=" gradle.properties | cut -d'=' -f2 || echo "")
          BRANCH_NAME=${GITHUB_REF#refs/heads/}
          
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "Current library version: $CURRENT_VERSION"
          echo "Current branch: $BRANCH_NAME"
      
      - name: Determine final version
        id: final_version
        run: |
          CURRENT="${{ steps.version_info.outputs.current_version }}"
          BRANCH_NAME="${{ steps.version_info.outputs.branch_name }}"
          
          # æ ¹æ®åˆ†æ”¯è®¾ç½®ç‰ˆæœ¬è§„åˆ™
          if [ "$BRANCH_NAME" == "main" ] || [ "$BRANCH_NAME" == "master" ]; then
            # mainåˆ†æ”¯ï¼šä»0.0.1å¼€å§‹
            if [ -z "$CURRENT" ] || [ "$CURRENT" == "" ]; then
              BASE_VERSION="0.0.1"
            else
              BASE_VERSION="$CURRENT"
            fi
          elif [ "$BRANCH_NAME" == "develop" ]; then
            # developåˆ†æ”¯ï¼šä»1.0.0å¼€å§‹
            if [ -z "$CURRENT" ] || [ "$CURRENT" == "" ]; then
              BASE_VERSION="1.0.0"
            else
              BASE_VERSION="$CURRENT"
            fi
          else
            # å…¶ä»–åˆ†æ”¯ï¼šä½¿ç”¨å½“å‰ç‰ˆæœ¬æˆ–é»˜è®¤å€¼
            BASE_VERSION=${CURRENT:-"0.0.1"}
          fi
          
          # ç¡®å®šæœ€ç»ˆç‰ˆæœ¬
          if [ -n "${{ github.event.inputs.version }}" ]; then
            FINAL_VERSION="${{ github.event.inputs.version }}"
            echo "Using manually specified version: $FINAL_VERSION"
          elif [ "${{ github.event.inputs.auto_increment }}" == "true" ]; then
            # è‡ªåŠ¨é€’å¢æœ€åä¸€ä½
            FINAL_VERSION=$(echo "$BASE_VERSION" | awk -F. '{printf "%d.%d.%d", $1, $2, $3+1}')
            echo "Auto-incremented version: $BASE_VERSION -> $FINAL_VERSION"
          else
            FINAL_VERSION="$BASE_VERSION"
            echo "Using current version: $FINAL_VERSION"
          fi
          
          # éªŒè¯æœ€ç»ˆç‰ˆæœ¬å·æ ¼å¼
          if [[ ! "$FINAL_VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+(-[A-Za-z0-9-]+)?$ ]]; then
            echo "âŒ Invalid final version format: $FINAL_VERSION"
            exit 1
          fi
          
          echo "final_version=$FINAL_VERSION" >> $GITHUB_OUTPUT
          echo "âœ… Final version to publish: $FINAL_VERSION (branch: $BRANCH_NAME)"
      
      - name: Check if version already exists
        id: check_version
        run: |
          VERSION="${{ steps.final_version.outputs.final_version }}"
          GROUP_ID="io.github.xichenx"
          ARTIFACT_ID="lumen"
          
          echo "Checking if version $VERSION already exists in Maven Central..."
          
          # æ£€æŸ¥ Maven Central æ˜¯å¦å·²å­˜åœ¨è¯¥ç‰ˆæœ¬
          URL="https://repo1.maven.org/maven2/${GROUP_ID//./\/}/$ARTIFACT_ID/$VERSION/"
          
          # ä½¿ç”¨è¶…æ—¶å’Œé‡è¯•æœºåˆ¶æ£€æŸ¥ç‰ˆæœ¬
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" --max-time 10 --retry 2 "$URL" || echo "000")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âš ï¸  Version $VERSION already exists in Maven Central!"
            echo "should_publish=false" >> $GITHUB_OUTPUT
            echo "existing_url=$URL" >> $GITHUB_OUTPUT
          elif [ "$HTTP_CODE" = "000" ]; then
            echo "âš ï¸  Failed to check Maven Central (network error), proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          else
            echo "âœ… Version $VERSION is new (HTTP $HTTP_CODE), proceeding with publish"
            echo "should_publish=true" >> $GITHUB_OUTPUT
          fi
      
      - name: Validate secrets
        run: |
          MISSING_SECRETS=()
          
          if [ -z "${{ secrets.SONATYPE_USERNAME }}" ]; then
            MISSING_SECRETS+=("SONATYPE_USERNAME")
          fi
          
          if [ -z "${{ secrets.SONATYPE_PASSWORD }}" ]; then
            MISSING_SECRETS+=("SONATYPE_PASSWORD")
          fi
          
          if [ -z "${{ secrets.GPG_PRIVATE_KEY }}" ]; then
            MISSING_SECRETS+=("GPG_PRIVATE_KEY")
          fi
          
          if [ -z "${{ secrets.GPG_PASSPHRASE }}" ]; then
            MISSING_SECRETS+=("GPG_PASSPHRASE")
          fi
          
          if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
            echo "âš ï¸  Missing secrets: ${MISSING_SECRETS[*]}"
            echo "Publish will be skipped, but artifacts will be built"
          else
            echo "âœ… All required secrets are configured"
          fi

  publish:
    runs-on: ubuntu-latest
    needs: pre-check
    if: needs.pre-check.outputs.should_publish == 'true'
    permissions:
      contents: write
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Set up JDK
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Get version from pre-check
        id: version
        run: |
          echo "version=${{ needs.pre-check.outputs.version }}" >> $GITHUB_OUTPUT
          echo "âœ… Using version: ${{ needs.pre-check.outputs.version }}"
      
      - name: Update version in gradle.properties
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          # æ›´æ–°ç»„ä»¶ç‰ˆæœ¬ï¼ˆç‹¬ç«‹äºdemoç‰ˆæœ¬ï¼‰
          if grep -q "^LIBRARY_VERSION_NAME=" gradle.properties; then
            sed -i "s/^LIBRARY_VERSION_NAME=.*/LIBRARY_VERSION_NAME=$VERSION/" gradle.properties
          else
            echo "LIBRARY_VERSION_NAME=$VERSION" >> gradle.properties
          fi
          # åŒæ—¶æ›´æ–°VERSION_NAMEä»¥ä¿æŒå…¼å®¹
          sed -i "s/^VERSION_NAME=.*/VERSION_NAME=$VERSION/" gradle.properties
          echo "âœ… Updated LIBRARY_VERSION_NAME and VERSION_NAME to $VERSION"
          grep -E "^(LIBRARY_VERSION_NAME|VERSION_NAME)=" gradle.properties || true
      
      - name: Setup Gradle
        uses: gradle/gradle-build-action@v2
        with:
          cache-read-only: false
          gradle-home-cache-includes: |
            caches
            notifications
            jdks
      
      - name: Grant execute permission for gradlew
        run: chmod +x gradlew
      
      - name: Validate Gradle configuration
        run: |
          echo "Validating Gradle configuration..."
          ./gradlew tasks --all --console=plain | head -20
          echo "âœ… Gradle configuration is valid"
      
      - name: Build and test
        id: build
        run: |
          echo "Building and testing all modules..."
          ./gradlew clean build test \
            --parallel \
            --max-workers=4 \
            --stacktrace \
            --no-daemon \
            --console=plain
          
          if [ $? -eq 0 ]; then
            echo "build_success=true" >> $GITHUB_OUTPUT
            echo "âœ… Build and test completed successfully"
          else
            echo "build_success=false" >> $GITHUB_OUTPUT
            echo "âŒ Build or test failed"
            exit 1
          fi
      
      - name: Setup GPG
        id: gpg_setup
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}
        run: |
          if [ -z "$GPG_PRIVATE_KEY" ] || [ -z "$GPG_PASSPHRASE" ]; then
            echo "âš ï¸  GPG credentials not configured, signing will be skipped"
            echo "gpg_configured=false" >> $GITHUB_OUTPUT
            echo "GPG_KEY_ID=" >> $GITHUB_ENV
            exit 0
          fi
          
          echo "Setting up GPG signing..."
          
          # æ£€æµ‹å¯†é’¥æ ¼å¼å¹¶å¯¼å…¥ GPG å¯†é’¥
          # æ”¯æŒä¸¤ç§æ ¼å¼ï¼š
          # 1. ASCII armor æ ¼å¼ï¼ˆåŒ…å« -----BEGIN PGP PRIVATE KEY BLOCK-----ï¼‰
          # 2. Base64 ç¼–ç æ ¼å¼ï¼ˆéœ€è¦è§£ç ï¼‰
          
          # ä½¿ç”¨ grep -F è¿›è¡Œå›ºå®šå­—ç¬¦ä¸²åŒ¹é…ï¼Œé¿å…å°† - è§£é‡Šä¸ºé€‰é¡¹
          # æˆ–è€…ä½¿ç”¨ echo + grep çš„ç»„åˆæ¥é¿å…é€‰é¡¹è§£æé—®é¢˜
          if echo "$GPG_PRIVATE_KEY" | grep -F -- "-----BEGIN PGP" > /dev/null 2>&1; then
            # ASCII armor æ ¼å¼ï¼Œç›´æ¥å¯¼å…¥
            echo "ğŸ“‹ Detected ASCII armor format GPG key"
            echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import 2>&1 || {
              echo "âŒ Failed to import GPG key (ASCII armor format)"
              echo "   Debug: Checking key format..."
              echo "$GPG_PRIVATE_KEY" | head -5
              exit 1
            }
          else
            # Base64 ç¼–ç æ ¼å¼ï¼Œéœ€è¦è§£ç 
            echo "ğŸ“‹ Detected Base64 encoded GPG key"
            # æ¸…ç†å¯èƒ½çš„å¤´éƒ¨/å°¾éƒ¨æ ‡è®°å’Œç©ºè¡Œï¼ˆç±»ä¼¼ keystore çš„å¤„ç†ï¼‰
            CLEANED_KEY=$(echo "$GPG_PRIVATE_KEY" | \
              sed -e '/-----BEGIN CERTIFICATE-----/d' \
                  -e '/-----END CERTIFICATE-----/d' \
                  -e '/-----BEGIN PGP PRIVATE KEY BLOCK-----/d' \
                  -e '/-----END PGP PRIVATE KEY BLOCK-----/d' \
                  -e '/-----BEGIN PGP PUBLIC KEY BLOCK-----/d' \
                  -e '/-----END PGP PUBLIC KEY BLOCK-----/d' \
                  -e '/^$/d' | \
              tr -d '\n\r ')
            
            # å°è¯• base64 è§£ç 
            if echo "$CLEANED_KEY" | base64 -d 2>/dev/null | gpg --batch --yes --import 2>&1; then
              echo "âœ… GPG key imported successfully (Base64 format)"
            else
              echo "âŒ Failed to import GPG key (Base64 format)"
              echo "   Make sure GPG_PRIVATE_KEY is properly base64 encoded"
              echo "   Or use ASCII armor format (with -----BEGIN PGP PRIVATE KEY BLOCK-----)"
              echo ""
              echo "   Debug info:"
              echo "   - Key length: ${#CLEANED_KEY} characters"
              echo "   - First 50 chars: ${CLEANED_KEY:0:50}..."
              exit 1
            fi
          fi
          
          # æå–å¯†é’¥ IDï¼ˆé•¿æ ¼å¼ï¼‰
          KEY_ID_LONG=$(gpg --list-secret-keys --keyid-format LONG 2>/dev/null | grep -E "^(sec|SEC)" | head -1 | awk '{print $2}' | cut -d'/' -f2)
          
          if [ -z "$KEY_ID_LONG" ]; then
            echo "âŒ Failed to extract GPG key ID"
            echo "   Listing available keys for debugging:"
            gpg --list-secret-keys --keyid-format LONG 2>/dev/null || true
            exit 1
          fi
          
          # Gradle ç­¾åæ’ä»¶éœ€è¦çŸ­æ ¼å¼ï¼ˆ8ä½åå…­è¿›åˆ¶ï¼‰
          # æå–çŸ­æ ¼å¼ï¼ˆæœ€å8ä½ï¼Œå»æ‰å¯èƒ½çš„æ¢è¡Œç¬¦ï¼‰
          KEY_ID_SHORT=$(echo "$KEY_ID_LONG" | tail -c 9 | tr -d '\n\r ')
          
          # éªŒè¯çŸ­æ ¼å¼å¯†é’¥ IDï¼ˆåº”è¯¥æ˜¯8ä½åå…­è¿›åˆ¶ï¼‰
          if [ ${#KEY_ID_SHORT} -ne 8 ]; then
            echo "âš ï¸  Short key ID length is ${#KEY_ID_SHORT}, expected 8"
            # å¦‚æœæå–å¤±è´¥ï¼Œå°è¯•ä»é•¿æ ¼å¼ä¸­æå–æœ€å8ä½
            KEY_ID_SHORT=$(echo "$KEY_ID_LONG" | grep -oE "[0-9A-Fa-f]{8}$" | tail -1)
          fi
          
          if [ -z "$KEY_ID_SHORT" ] || [ ${#KEY_ID_SHORT} -ne 8 ]; then
            echo "âŒ Failed to extract short GPG key ID"
            echo "   Long key ID: $KEY_ID_LONG"
            exit 1
          fi
          
          # Gradle ä½¿ç”¨çŸ­æ ¼å¼ï¼ˆ8ä½ï¼‰
          echo "GPG_KEY_ID=$KEY_ID_SHORT" >> $GITHUB_ENV
          echo "GPG_KEY_ID_LONG=$KEY_ID_LONG" >> $GITHUB_ENV
          echo "gpg_configured=true" >> $GITHUB_OUTPUT
          echo "âœ… GPG Key ID (Long): $KEY_ID_LONG"
          echo "âœ… GPG Key ID (Short for Gradle): $KEY_ID_SHORT"
          
          # é…ç½® GPG ä»¥åœ¨éäº¤äº’å¼ç¯å¢ƒä¸­å·¥ä½œ
          mkdir -p ~/.gnupg
          echo "pinentry-mode loopback" >> ~/.gnupg/gpg.conf
          echo "allow-loopback-pinentry" >> ~/.gnupg/gpg-agent.conf 2>/dev/null || echo "allow-loopback-pinentry" > ~/.gnupg/gpg-agent.conf
          
          # é‡å¯ gpg-agent ä»¥åº”ç”¨é…ç½®
          gpgconf --kill gpg-agent 2>/dev/null || true
          
          # å¯¼å‡ºå¯†é’¥æ–‡ä»¶ç”¨äº Gradle ç­¾å
          # æ–¹æ³•1: ä½¿ç”¨ --pinentry-mode loopback å’Œ --passphrase-fd
          echo "ğŸ“¤ Exporting GPG key..."
          echo "   Using key ID: $KEY_ID_LONG"
          if echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --export-secret-keys --armor "$KEY_ID_LONG" > secret.gpg 2>&1; then
            # éªŒè¯å¯¼å‡ºçš„æ–‡ä»¶
            if [ -f secret.gpg ] && [ -s secret.gpg ] && grep -q "BEGIN PGP PRIVATE KEY BLOCK" secret.gpg; then
              echo "âœ… GPG key exported successfully to secret.gpg"
            else
              echo "âš ï¸  Exported file seems invalid, trying method 2..."
              rm -f secret.gpg
            fi
          else
            echo "âš ï¸  Method 1 failed, trying method 2..."
            rm -f secret.gpg
          fi
          
          # æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨ç¯å¢ƒå˜é‡
          if [ ! -f secret.gpg ] || [ ! -s secret.gpg ]; then
            echo "ğŸ“¤ Trying alternative export method..."
            GPG_TTY=$(tty) || GPG_TTY=/dev/tty
            export GPG_TTY
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --export-secret-keys --armor "$KEY_ID_LONG" > secret.gpg 2>&1 || {
              echo "âš ï¸  Method 2 also failed, trying method 3..."
              rm -f secret.gpg
            }
          fi
          
          # æ–¹æ³•3: å¦‚æœå‰ä¸¤ç§æ–¹æ³•éƒ½å¤±è´¥ï¼Œå°è¯•é‡æ–°å¯¼å…¥å¹¶å¯¼å‡º
          if [ ! -f secret.gpg ] || [ ! -s secret.gpg ]; then
            echo "ğŸ“¤ Trying method 3: re-import and export..."
            # é‡æ–°å¯¼å…¥å¯†é’¥ï¼ˆç¡®ä¿åœ¨æ­£ç¡®çš„ç¯å¢ƒä¸­ï¼‰
            if echo "$GPG_PRIVATE_KEY" | grep -F -- "-----BEGIN PGP" > /dev/null 2>&1; then
              echo "$GPG_PRIVATE_KEY" | gpg --batch --yes --import 2>&1
            else
              CLEANED_KEY=$(echo "$GPG_PRIVATE_KEY" | \
                sed -e '/-----BEGIN CERTIFICATE-----/d' \
                    -e '/-----END CERTIFICATE-----/d' \
                    -e '/-----BEGIN PGP PRIVATE KEY BLOCK-----/d' \
                    -e '/-----END PGP PRIVATE KEY BLOCK-----/d' \
                    -e '/-----BEGIN PGP PUBLIC KEY BLOCK-----/d' \
                    -e '/-----END PGP PUBLIC KEY BLOCK-----/d' \
                    -e '/^$/d' | \
                tr -d '\n\r ')
              echo "$CLEANED_KEY" | base64 -d 2>/dev/null | gpg --batch --yes --import 2>&1
            fi
            # å†æ¬¡å°è¯•å¯¼å‡º
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --export-secret-keys --armor "$KEY_ID_LONG" > secret.gpg 2>&1 || true
          fi
          
          # æœ€ç»ˆéªŒè¯
          if [ -f secret.gpg ] && [ -s secret.gpg ] && grep -q "BEGIN PGP PRIVATE KEY BLOCK" secret.gpg; then
            echo "âœ… GPG key successfully exported to secret.gpg"
            echo "   File size: $(wc -c < secret.gpg) bytes"
            SECRET_GPG_PATH="$(pwd)/secret.gpg"
            echo "   File location: $SECRET_GPG_PATH"
            echo "   File absolute path: $(realpath secret.gpg 2>/dev/null || echo "$SECRET_GPG_PATH")"
            # ç¡®ä¿æ–‡ä»¶æƒé™æ­£ç¡®
            chmod 600 secret.gpg
            # å°†æ–‡ä»¶è·¯å¾„ä¿å­˜åˆ°ç¯å¢ƒå˜é‡ï¼Œä¾›åç»­æ­¥éª¤ä½¿ç”¨
            echo "GPG_KEY_FILE=$SECRET_GPG_PATH" >> $GITHUB_ENV
            # åŒæ—¶ä¿å­˜åˆ°è¾“å‡ºï¼Œç”¨äºè°ƒè¯•
            echo "gpg_key_file=$SECRET_GPG_PATH" >> $GITHUB_OUTPUT
          else
            echo "âŒ Failed to export GPG key after all methods"
            echo "   This will cause signing to fail"
            echo "   Debug: Listing keys in keyring"
            gpg --list-secret-keys --keyid-format LONG 2>&1 || true
            exit 1
          fi
      
      - name: Publish to Maven Central
        id: publish
        env:
          SONATYPE_USERNAME: ${{ secrets.SONATYPE_USERNAME }}
          SONATYPE_PASSWORD: ${{ secrets.SONATYPE_PASSWORD }}
          SIGNING_KEY_ID: ${{ env.GPG_KEY_ID }}
          SIGNING_PASSWORD: ${{ secrets.GPG_PASSPHRASE }}
          SIGNING_SECRET_KEY_RING_FILE: ${{ env.GPG_KEY_FILE || 'secret.gpg' }}
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          
          # ç¡®å®š secret.gpg æ–‡ä»¶è·¯å¾„
          GPG_KEY_FILE="${SIGNING_SECRET_KEY_RING_FILE:-secret.gpg}"
          
          # éªŒè¯ secret.gpg æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "$GPG_KEY_FILE" ] || [ ! -s "$GPG_KEY_FILE" ]; then
            echo "âŒ secret.gpg file not found or empty"
            echo "   Looking for: $GPG_KEY_FILE"
            echo "   Current directory: $(pwd)"
            echo "   Files in current directory:"
            ls -la | head -20
            echo "   Looking for secret.gpg..."
            find . -name "secret.gpg" 2>/dev/null || echo "   secret.gpg not found"
            # å°è¯•ä»ç¯å¢ƒå˜é‡è·å–è·¯å¾„
            if [ -n "${{ env.GPG_KEY_FILE }}" ]; then
              echo "   Trying path from env: ${{ env.GPG_KEY_FILE }}"
              if [ -f "${{ env.GPG_KEY_FILE }}" ]; then
                GPG_KEY_FILE="${{ env.GPG_KEY_FILE }}"
                echo "âœ… Found secret.gpg at: $GPG_KEY_FILE"
              fi
            fi
            if [ ! -f "$GPG_KEY_FILE" ]; then
              exit 1
            fi
          fi
          
          echo "âœ… secret.gpg file found: $(ls -lh "$GPG_KEY_FILE")"
          echo "   Using file: $GPG_KEY_FILE"
          # æ›´æ–°ç¯å¢ƒå˜é‡ä»¥ä½¿ç”¨æ­£ç¡®çš„è·¯å¾„
          export SIGNING_SECRET_KEY_RING_FILE="$GPG_KEY_FILE"
          
          if [ -z "$SONATYPE_USERNAME" ] || [ -z "$SONATYPE_PASSWORD" ]; then
            echo "âš ï¸  Sonatype credentials not configured, skipping Maven Central publish"
            echo "Building artifacts for manual upload..."
            ./gradlew publishAllToMavenLocal \
                      --parallel \
                      --max-workers=4 \
                      --no-daemon \
                      --stacktrace
            echo "publish_success=false" >> $GITHUB_OUTPUT
            echo "publish_skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸš€ Publishing version $VERSION to Maven Central..."
          echo "ğŸ“¦ Publishing modules: lumen-core, lumen-view, lumen-transform, lumen"
          echo "âš¡ Using optimized parallel publishing with dependency management..."
          
          # å…ˆåˆ—å‡ºå¯ç”¨çš„å‘å¸ƒä»»åŠ¡ï¼ˆç”¨äºè°ƒè¯•ï¼‰
          echo "ğŸ“‹ Available publish tasks:"
          ./gradlew tasks --all --group=publishing 2>&1 | grep -i "publish" || true
          
          # ä½¿ç”¨èšåˆä»»åŠ¡ + å¹¶è¡Œæ‰§è¡Œä¼˜åŒ–
          # æ³¨æ„ï¼šä½¿ç”¨ --dry-run å…ˆéªŒè¯ä»»åŠ¡æ˜¯å¦å­˜åœ¨
          if ./gradlew publishAllToMavenCentral --dry-run --no-daemon 2>&1 | grep -q "publishAllToMavenCentral"; then
            echo "âœ… Task publishAllToMavenCentral found, proceeding with publish..."
          else
            echo "âš ï¸  Task publishAllToMavenCentral not found, trying individual tasks..."
            # å¦‚æœèšåˆä»»åŠ¡ä¸å­˜åœ¨ï¼Œå°è¯•å•ç‹¬å‘å¸ƒæ¯ä¸ªæ¨¡å—
            ./gradlew \
              :lumen-core:publishReleasePublicationToMavenCentralRepository \
              :lumen-transform:publishReleasePublicationToMavenCentralRepository \
              :lumen-view:publishReleasePublicationToMavenCentralRepository \
              :lumen:publishReleasePublicationToMavenCentralRepository \
              --parallel \
              --max-workers=4 \
              --no-daemon \
              --stacktrace \
              --console=plain
            if [ $? -eq 0 ]; then
              echo "âœ… Published successfully to Maven Central!"
              echo "publish_success=true" >> $GITHUB_OUTPUT
              echo "publish_skipped=false" >> $GITHUB_OUTPUT
              exit 0
            else
              echo "âŒ Failed to publish"
              exit 1
            fi
          fi
          
          if ./gradlew publishAllToMavenCentral \
                      --parallel \
                      --max-workers=4 \
                      --no-daemon \
                      --stacktrace \
                      --console=plain; then
            echo "âœ… Published successfully to Maven Central!"
            echo "publish_success=true" >> $GITHUB_OUTPUT
            echo "publish_skipped=false" >> $GITHUB_OUTPUT
            
            echo ""
            echo "ğŸ“‹ Next steps:"
            echo "1. Login to https://s01.oss.sonatype.org"
            echo "2. Go to Staging Repositories"
            echo "3. Find your repository and click Close"
            echo "4. Wait for validation, then click Release"
            echo "5. Wait for sync to Maven Central (usually a few hours)"
          else
            echo "âŒ Failed to publish to Maven Central"
            echo "publish_success=false" >> $GITHUB_OUTPUT
            echo "publish_skipped=false" >> $GITHUB_OUTPUT
            exit 1
          fi
      
      - name: Verify published artifacts
        if: steps.publish.outputs.publish_success == 'true'
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          GROUP_ID="io.github.xichenx"
          MODULES=("lumen-core" "lumen-transform" "lumen-view" "lumen")
          
          echo "ğŸ” Verifying published artifacts..."
          
          # ç­‰å¾… Sonatype å¤„ç†
          echo "â³ Waiting for Sonatype to process artifacts (10 seconds)..."
          sleep 10
          
          STAGING_URL="https://s01.oss.sonatype.org/service/local/staging/repository"
          FAILED_MODULES=()
          
          for MODULE in "${MODULES[@]}"; do
            echo "Checking $MODULE..."
            # æ£€æŸ¥ staging ä»“åº“ï¼ˆè¿™é‡Œåªæ˜¯åŸºæœ¬æ£€æŸ¥ï¼Œå®é™…éªŒè¯éœ€è¦ç™»å½• Sonatypeï¼‰
            echo "  âœ… $MODULE artifacts should be in staging repository"
          done
          
          echo "âœ… All modules published to staging repository"
          echo "âš ï¸  Note: Final verification requires manual check in Sonatype Nexus"
      
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts-${{ needs.pre-check.outputs.version }}
          path: |
            **/build/publications/**/*.pom
            **/build/publications/**/*.aar
            **/build/publications/**/*.jar
            **/build/publications/**/*.asc
          retention-days: 30
          compression-level: 6
      
      - name: Commit version update back to repository
        if: github.event_name == 'push' && steps.publish.outputs.publish_success == 'true'
        run: |
          VERSION="${{ needs.pre-check.outputs.version }}"
          
          # é…ç½® git ç”¨æˆ·ä¿¡æ¯
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          
          # æ£€æŸ¥ gradle.properties æ˜¯å¦æœ‰å˜æ›´
          if ! git diff --quiet gradle.properties; then
            echo "ğŸ“ Version change detected, committing update to repository"
            git add gradle.properties
            git commit -m "chore: bump version to $VERSION [skip ci]"
            
            # è·å–å½“å‰åˆ†æ”¯åï¼ˆé€šå¸¸æ˜¯ main æˆ– masterï¼‰
            BRANCH=$(git rev-parse --abbrev-ref HEAD)
            echo "ğŸ“¤ Pushing version update to $BRANCH branch"
            
            # é‡è¯•æœºåˆ¶
            MAX_RETRIES=3
            RETRY_COUNT=0
            while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
              if git push origin HEAD:$BRANCH; then
                echo "âœ… Version update pushed successfully"
                break
              else
                RETRY_COUNT=$((RETRY_COUNT + 1))
                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  echo "âš ï¸  Push failed, retrying in 5 seconds... (attempt $RETRY_COUNT/$MAX_RETRIES)"
                  sleep 5
                else
                  echo "âš ï¸  Failed to push after $MAX_RETRIES attempts, skipping"
                fi
              fi
            done
          else
            echo "â„¹ï¸  No version change detected in gradle.properties, skipping commit"
          fi
      
      - name: Create GitHub Release
        if: github.event_name == 'push' && steps.publish.outputs.publish_success == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ github.ref }}
          name: Release v${{ needs.pre-check.outputs.version }}
          body: |
            ## ğŸ“¦ Maven Central Release
            
            Version: **${{ needs.pre-check.outputs.version }}**
            
            ### ğŸ“‹ Published Modules
            
            - âœ… **lumen-core** - Core loading logic
            - âœ… **lumen-view** - ImageView and Compose support
            - âœ… **lumen-transform** - Image transformation features
            - âœ… **lumen** - Aggregated module (includes all sub-modules)
            
            ### ğŸš€ Usage
            
            ```kotlin
            repositories {
                mavenCentral()
            }
            
            dependencies {
                // èšåˆæ¨¡å—ï¼ˆæ¨èï¼‰- è‡ªåŠ¨åŒ…å«æ‰€æœ‰å­æ¨¡å—
                implementation("io.github.xichenx:lumen:${{ needs.pre-check.outputs.version }}")
                
                // æˆ–ç‹¬ç«‹æ¨¡å—
                implementation("io.github.xichenx:lumen-core:${{ needs.pre-check.outputs.version }}")
                implementation("io.github.xichenx:lumen-view:${{ needs.pre-check.outputs.version }}")
                implementation("io.github.xichenx:lumen-transform:${{ needs.pre-check.outputs.version }}")
            }
            ```
            
            ### ğŸ“ Next Steps
            
            1. Login to [Sonatype](https://s01.oss.sonatype.org)
            2. Go to **Staging Repositories**
            3. Find your repository and click **Close**
            4. Wait for validation, then click **Release**
            5. Wait for sync to Maven Central (usually a few hours)
            
            ### ğŸ”— Links
            
            - [Maven Central](https://repo1.maven.org/maven2/io/github/xichenx/)
            - [Sonatype Staging](https://s01.oss.sonatype.org)
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Publish summary
        if: always()
        run: |
          echo "## ğŸ“Š Publish Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Version | \`${{ needs.pre-check.outputs.version }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| Build | ${{ steps.build.outputs.build_success == 'true' && 'âœ… Success' || 'âŒ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Publish | ${{ steps.publish.outputs.publish_success == 'true' && 'âœ… Success' || (steps.publish.outputs.publish_skipped == 'true' && 'âš ï¸ Skipped' || 'âŒ Failed') }} |" >> $GITHUB_STEP_SUMMARY
          echo "| GPG Signing | ${{ steps.gpg_setup.outputs.gpg_configured == 'true' && 'âœ… Configured' || 'âš ï¸ Not Configured' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.publish.outputs.publish_success }}" == "true" ]; then
            echo "### âœ… Publish completed successfully!" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Next steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Check [Sonatype Staging](https://s01.oss.sonatype.org)" >> $GITHUB_STEP_SUMMARY
            echo "2. Close and release the staging repository" >> $GITHUB_STEP_SUMMARY
            echo "3. Wait for sync to Maven Central" >> $GITHUB_STEP_SUMMARY
          fi

